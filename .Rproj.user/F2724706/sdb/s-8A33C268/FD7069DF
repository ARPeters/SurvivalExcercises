{
    "contents" : "library(survival)\nlibrary(foreign)\n\nrm(list=ls(all=TRUE))\n################################\n#CHAPTER 5: Practice\n################################\n\n#Read vets dataset\n#File Layout\n# Column 1: Treatment (standard = 1, test = 2)\n# Column 2: Cell type 1 (large = 1, other = 0)\n# Column 3: Cell type 2 (adeno = 1, other = 0)\n# Column 4: Cell type 3 (small = 1, other = 0)\n# Column 5: Cell type 4 (squamous = 1, other = 0)\n# Column 6: Survival time (days)\n# Column 7: Performance status (0 = worst, ..., 100 = best)\n# Column 8: disease duration (months)\n# Column 9: Age\n# Column 10: Prior therapy (none = 0, some = 10)\n# Column 11: Status (0 = censored, 1 = died)\n\ndsVets <- read.dta(\"http://web1.sph.emory.edu/dkleinb/allDatasets/surv2datasets/vets.dta\")\n\n\nnames(dsVets)<-c(\"Treatment\", \"LargeCell\", \"AdenoCell\", \"SmallCell\", \"SquamousCell\", \"SurvivalTime\", \"PerformanceStatus\", \n                 \"DiseaseDuration\", \"Age\", \"PriorTherapy\", \"Status\")\n\n\n#adding a subject ID variable for dsVets\n\nnumrows <- nrow(dsVets)\n\ndsVets$Subject <- c(1:numrows)\n\n\n###Question:  How do you make a variable \"readable\" with a space in the variable name:\n###           i.e. dsVets$Survival Time versus dsVets$SurvivalTime\n\n#Practice Question 1\n\n\nCh5Practice1a <- coxph(Surv(SurvivalTime, Status==1) ~ Treatment + LargeCell + AdenoCell + \n                        SmallCell + PerformanceStatus + DiseaseDuration + Age + PriorTherapy, data = dsVets, ties=\"breslow\")\nsummary(Ch5Practice1a)\n\n\nCh5Practice1b <- coxph(Surv(SurvivalTime, Status==1) ~ Treatment +  \n                         SmallCell + PerformanceStatus + DiseaseDuration + Age + PriorTherapy, data = dsVets, ties=\"breslow\")\nsummary(Ch5Practice1b)\n\n\n##Create New Variables Z1 Small cell\n##                     Z2 Performance Status High (60 or above) or Low (Below 60)\n\ndsVets$Z1 = dsVets$SmallCell\ndsVets$Z2 <- ifelse(dsVets$PerformanceStatus > 59, 1, 0)\n\n\n\nCh5Practice3 <- coxph(Surv(SurvivalTime, Status==1) ~ Treatment + DiseaseDuration + Age + PriorTherapy + strata(Z1, Z2), data = dsVets, ties=\"breslow\")\nsummary(Ch5Practice3)\n\nCh5Practice3a <- coxph(Surv(SurvivalTime, Status) ~ Treatment + DiseaseDuration + Age + PriorTherapy + strata(Z1), data = dsVets, ties=\"breslow\")\nsummary(Ch5Practice3a)\n\n\n\n\n#GLM Procedure\nrequire(plyr)\n\ncreateEventTimes <- function(d){\n\teventTimes <- unique(d$SurvivalTime[d$Status==1])\n\teventTimes <- eventTimes[order(eventTimes)]\n\treturn(eventTimes)\n}\n\ncreatePTable <- function(d){\n  eventTimes <- createEventTimes(dsVets[dsVets$Z1 %in% unique(d$Z1),])\n  #eventTimes <- createEventTimes(dsVets)\n  dNew <- d\n  for(i in 1:length(eventTimes)){\n    dNew[i,] <- d\n    dNew[i,\"r\"] <- i\n    dNew[i,\"tr\"] <- eventTimes[i]\n    dNew[i,\"dir\"] <- ifelse(i==1,min(d$SurvivalTime,eventTimes[i]),min(d$SurvivalTime,eventTimes[i]) - eventTimes[i-1])\n    dNew[i,\"yir\"] <- 0\n    if(d$SurvivalTime <= eventTimes[i]) {\n      if(d$Status %in% 1) dNew[i,\"yir\"] <- 1\n      break      \n    }      \n  }    \n  return(dNew)\n}\n\nctProcessDat <- ddply(.data=dsVets,.variables=.(Subject,Z1,Z2),.fun = createPTable)\nctProcessDat[ctProcessDat$Subject %in% c(166,111),]\nmax(ctProcessDat$r)\nctProcessDat$rNew <- paste0(ctProcessDat$r,ctProcessDat$Z1,ctProcessDat$Z2)\ndim(ctProcessDat)\ncolnames(dsVets)\ntable(ctProcessDat$rNew)\n\n#The counting process version of a Cox regression model\n#Ch5Practice3PoissonNewA <- glm(yir ~ I(as.factor(r)):strata(Z1) + Treatment + DiseaseDuration + Age + PriorTherapy + offset(I(log(dir))), family=poisson(link = \"log\"), data=ctProcessDat)\nCh5Practice3PoissonNewB <- glm(yir ~ I(as.factor(rNew)) + Treatment + DiseaseDuration + Age + PriorTherapy + offset(I(log(dir))), family=poisson(link = \"log\"), data=ctProcessDat)\nsummary(Ch5Practice3PoissonNewB)\n\nsummary(Ch5Practice3)$coefficients[,c(1,3:5)]\n#summary(Ch5Practice3PoissonNewA)$coefficients[2:5,]\nsummary(Ch5Practice3PoissonNewB)$coefficients[(nrow(summary(Ch5Practice3PoissonNewB)$coefficients)-3):nrow(summary(Ch5Practice3PoissonNewB)$coefficients),]\n\n#ctProcessDat[order(ctProcessDat$r,ctProcessDat$Z1,ctProcessDat$Subject),c(\"Subject\",\"Z1\",\"r\")][1:200,]\n\n\n\n\n#Ch5Practice10 <- coxph(Surv(SurvivalTime, Status==1) ~ Treatment + DiseaseDuration + Age + PriorTherapy + \n#                         DiseaseDuration:Z1 + Age:Z1 + PriorTherapy:Z1 + \n#                         DiseaseDuration:Z2 + Age:Z2 + PriorTherapy:Z2 + \n#                         DiseaseDuration:Z1:Z2 + Age:Z1:Z2 + PriorTherapy:Z1:Z2 + \n#                         Treatment:Z1 + Treatment:Z1 + Treatment:Z1:Z2 + \n#                         strata(Z1, Z2), data = dsVets, ties=\"breslow\")\nCh5Practice10 <- coxph(Surv(SurvivalTime, Status==1) ~ Treatment*strata(Z1,Z2) + DiseaseDuration*strata(Z1,Z2) + Age*strata(Z1,Z2) + PriorTherapy*strata(Z1,Z2), \n\t\tdata = dsVets, ties=\"breslow\")\nsummary(Ch5Practice10)\n\nCh5Practice10PoissonNew <- glm(yir ~ I(as.factor(rNew)) + Treatment + DiseaseDuration + Age + PriorTherapy + offset(I(log(dir))) +\n\t\t\t\t+ Treatment:Z1 + DiseaseDuration:Z1 + Age:Z1 + PriorTherapy:Z1 +\n\t\t\t\t+ Treatment:Z2 + DiseaseDuration:Z2 + Age:Z2 + PriorTherapy:Z2 +\n\t\t\t\t+ Treatment:Z1:Z2 + DiseaseDuration:Z1:Z2 + Age:Z1:Z2 + PriorTherapy:Z1:Z2, family=poisson(link = \"log\"), data=ctProcessDat)\nsummary(Ch5Practice10PoissonNew)\n\n\ncor(dsVets[,c()])\n\n\n\n",
    "created" : 1423580760103.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "805033581",
    "id" : "FD7069DF",
    "lastKnownWriteTime" : 1422976960,
    "path" : "~/GitHub/SurvivalExercises/Thomas/Survival Analysis/Ch5Tables.R",
    "project_path" : "Thomas/Survival Analysis/Ch5Tables.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}